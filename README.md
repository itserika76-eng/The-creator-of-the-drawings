# The creator of the drawings

Локальный прототип системы для подготовки чертежей под **КОМПАС-3D**.

## Что реализовано по требованиям

- ✅ Перенос с картинки: интегрирован CV-пайплайн, OCR рамки и улучшенная векторизация (skeleton-first + Hough + фильтрация ложных линий) для более похожего на исходник результата.
- ✅ Выбор версии КОМПАС: в GUI есть выбор `exe`/ярлыка перед запуском генерации.
- ✅ После генерации приложение автоматически открывает созданный **валидный** `.cdw` в выбранном КОМПАС и строит геометрию пошагово, чтобы процесс был виден.
- ✅ Локальное приложение: интерфейс на `tkinter` + отдельный `start_app.bat` для быстрого запуска в Windows.
- ✅ Генерация по запросу: система использует веб-поиск (Wikipedia API) и локальный RAG по нормативной базе.
- ✅ Проверка ГОСТ/ЕСКД: базовые чек-листы + модуль проверки обозначений, допусков и спецификации.
- ✅ Экспорт в `.cdw`/`.spw`: подключен слой COM/KOMPAS API с fallback-экспортом в dev-среде без COM.
- ✅ Юридический пайплайн обновлений: реестр легальных источников + генерация snapshot разрешённых источников.

> ⚠️ В Linux/dev-контейнере COM API КОМПАС обычно недоступен, поэтому создаются только `.fallback.json`. Это сделано специально, чтобы не генерировать повреждённые `.cdw/.spw`, которые КОМПАС не может открыть.

## Быстрый старт

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
python app/main.py
```

## Быстрый запуск в Windows

Запускайте `start_app.bat` из корня проекта — батник сам создаст `.venv`, установит зависимости и откроет GUI.

## Артефакты генерации

В папке `output/` формируются:

- `drawing_package.json` — структурированный пакет проекта;
- `specification.csv` — спецификация;
- `kompas_macro_template.py` — шаблон импорта;
- `<project>.cdw` — создаётся только при успешном создании реального документа через COM API КОМПАС.
- `<project>.spw` — создаётся по возможности (зависит от версии API), не блокирует создание `.cdw`.
- `<project>.cdw.fallback.json` и `<project>.spw.fallback.json` — диагностический fallback (не открываются как документы КОМПАС).

## Нормативная база и legal update

- Реестр источников: `app/data/standards_registry.json`.
- Локальные документы для RAG: `app/data/standards/*`.
- Пайплайн legal update: `app/legal_update.py` (создаёт `legal_sources_snapshot.json` только из разрешённых источников).

## Ограничения MVP

- Для сложных сборочных чертежей качество зависит от качества исходного изображения и параметров векторизации.
- OCR зависит от локальной установки Tesseract.
- RAG в MVP — retrieval по локальным текстам/выдержкам; для production нужен полнотекстовый индекс и контроль версий документов.

## Режим захвата окна КОМПАС (если COM рисует пусто)

Добавлен fallback: если COM не смог создать `.cdw`, программа всё равно запускает КОМПАС, создаёт новый документ через UI и пошагово рисует геометрию инструментом «Отрезок» по сегментам изображения.

### Что важно для стабильной работы
- Запускайте КОМПАС в стандартной раскладке интерфейса (не сильно кастомная лента).
- Окно КОМПАС должно быть на переднем плане и развернуто на весь экран.
- Не трогайте мышь/клавиатуру во время авто-построения.
- Для Windows установите зависимости `pyautogui` и `PyGetWindow` (уже в `requirements.txt` с маркером Windows).

### Мои предложения, как добиться максимальной надежности
1. **Лучший вариант**: использовать нативный COM API конкретной версии КОМПАС (без UI-автоматизации) и фиксированные вызовы `Document2D` с тестами на вашей версии КОМПАС.
2. Ввести профили версий КОМПАС (`v21`, `v23` и т.д.) с отдельными картами методов/сигнатур.
3. Добавить калибровку рабочего поля: один раз выбрать область листа мышью и сохранять профиль.
4. Добавить отладочный оверлей/скриншоты шагов рисования, чтобы видеть, где именно сбой.



### Почему раньше получался «непохожий» результат
- В векторизации было слишком много ложных сегментов из шумов/рамок.
- Координатный `box` при анализе и при UI-рисовании отличался, из-за этого линии уезжали.

### Что исправлено
- Единый `geometry_box` передаётся из векторизации в UI-рисование.
- Добавлены фильтры длины и стабилизация углов (горизонталь/вертикаль), чтобы убрать хаотичные диагонали.
